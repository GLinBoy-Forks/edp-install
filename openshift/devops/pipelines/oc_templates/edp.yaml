kind: Template
apiVersion: v1
metadata:
  name: edp
  annotations:
    description: |-
          Template for deploying EPAM Delivery Platform (EDP) aka "The Rocket" tools
    openshift.io/display-name: EDP - The Rocket
    template.openshift.io/provider-display-name: EPAM
    template.openshift.io/support-url: https://www.epam.com
objects:
- apiVersion: v1
  kind: ServiceAccount
  metadata:
    name: edp
- apiVersion: v1
  groupNames:
  - system:masters
  kind: ClusterRoleBinding
  metadata:
    annotations:
      openshift.io/reconcile-protect: "false"
    labels:
      kubernetes.io/bootstrapping: rbac-defaults
    name: edp-deploy-cluster-admin
  roleRef:
    name: cluster-admin
  subjects:
  - kind: ServiceAccount
    name: edp
    namespace: ${NAMESPACE}
  - kind: SystemGroup
    name: system:masters
  userNames:
  - system:serviceaccount:${NAMESPACE}:edp
- apiVersion: v1
  kind: SecurityContextConstraints
  allowHostDirVolumePlugin: true
  allowHostIPC: false
  allowHostNetwork: false
  allowHostPID: false
  allowHostPorts: true
  allowPrivilegedContainer: false
  allowedCapabilities: []
  allowedFlexVolumes: []
  defaultAddCapabilities: []
  fsGroup:
    type: RunAsAny
  groups:
  - system:cluster-admins
  metadata:
    name: edp-deploy
  priority: 10
  readOnlyRootFilesystem: false
  requiredDropCapabilities:
  - MKNOD
  runAsUser:
    type: RunAsAny
  seLinuxContext:
    type: MustRunAs
  supplementalGroups:
    type: RunAsAny
  users:
  - system:serviceaccount:${NAMESPACE}:edp
  volumes:
  - configMap
  - downwardAPI
  - emptyDir
  - hostPath
  - persistentVolumeClaim
  - projected
  - secret
- apiVersion: batch/v1
  kind: Job
  metadata:
    name: edp-deploy-${PROJECTS_PPERFIX}
  spec:
    parallelism: 1
    completions: 1
    template:
      metadata:
        name: edp-deploy
      spec:
        restartPolicy: Never
        serviceAccount: edp
        containers:
        - image: ${EDP_VERSION}
          imagePullPolicy: IfNotPresent
          name: edp-deploy
          command:
            - "ansible-playbook"
            - "-v"
            - "-i"
            - "localhost,"
            - "-e project=cicd-${PROJECTS_PPERFIX}"
            - "-e ocadm=oc"
            - "-e ansible_connection=local"
            - "-e gerrit.version=${GERRIT_VERSION}"
            - "-e tools.gerrit.volume_capacity=${GERRIT_DATA_CAPACITY}"
            - "-e tools.gerrit.volume_db_capacity=${GERRIT_DB_CAPACITY}"
            - "-e tools.jenkins.enable_oauth=${JENKINS_ENABLE_OAUTH}"
            - "-e tools.jenkins.volume_capacity=${JENKINS_VOLUME_CAPACITY}"
            - "-e tools.jenkins.maveUME_CAPACITY}"
            - "-e tools.jenkins.frontend_image=${JENNKINS_FRONTEND_IMAGE}"
            - "-e tools.jenkins.backend_image=${JENKINS_BACKEND_IMAGE}"
            - "-e toous.volume_capacity=${NEXUS_VOLUME_CAPACITY}"
            - "-e tools.sonar.version=${SONAR_VERSION}"
            - "-e tools.sonar.volume_capacity=${SONAR_VOLUME_CAPACITY_CAPACITY}"
            - "install/deploy_ci_tools/install.yml"
parameters:
- displayName: Image of EDP container
  description: Image and tag that defines version of EDP that will be deployed
  name: EDP_VERSION
  value: "docker-registry-default.main.edp.projects.epam.com/infra/edp-test:test"
- displayName: Prefix for projects
  description: Prefix that will be added to projects created by EDP Platform
  name: PROJECTS_PPERFIX
  value: "test"
- displayName: Namespace to run edp-deploy
  description: Namespace EDP platform will be deployed from
  name: NAMESPACE
  value: "infra"
#Gerrit parameters
- displayName: Gerrit version
  value: "2.14.1"
  name: GERRIT_VERSION
- displayName: Gerrit Volume Capacity
  description: Volume space available for Gerrit data
  name: GERRIT_DATA_CAPACITY
  value: 2Gi
  required: true
- displayName: Gerrit database Volume Capacity
  description: Volume space available for Gerrit DB
  name: GERRIT_DB_CAPACITY
  value: 2Gi
  required: true
- displayName: Gerrit WEB URL
  description: Gerrit WEB URL is needed for authentication purposes
  name: GERRIT_WEB_URL
  value: "http://gerrit-test-mb.demo.edp.projects.epam.com"
#Jenkins parameters
- displayName: Enable OAuth in Jenkins
  description: Whether to enable OAuth OpenShift integration. If false, the static
    account 'admin' will be initialized with the password 'password'.
  displayName: Enable OAuth in Jenkins
  name: JENKINS_ENABLE_OAUTH
  value: "false"
- displayName: Volume Capacity
  description: Volume space available for Jenkins data
  name: JENKINS_VOLUME_CAPACITY
  value: 5Gi
  required: true
- displayName: Maven Cache Volume Capacity
  description: Volume space available for maven cache data
  name: JENKINS_MAVEN_CACHE_VOLUME_CAPACITY
  required: true
  value: 5Gi
- displayName: Frontend docker image.
  name: JENNKINS_FRONTEND_IMAGE
  value: "docker-registry-default.main.edp.projects.epam.com/infra/nodejs-slave:6.12.2"
- displayName: Backend docker image.
  name: JENKINS_BACKEND_IMAGE
  value: "openshift/jenkins-slave-maven-centos7"
#Nexus parameters
- displayName: Sonatype Nexus version
  name: NEXUS_VERSION
  value: "3.6.2"
- displayName: Volume Space for Nexus
  description: Volume space available for Sonatype Nexus data
  name: NEXUS_VOLUME_CAPACITY
  value: 5Gi
#Sonar parameters
- displayName: SonarQube version
  value: "6.7"
  name: SONAR_VERSION
- description: Volume space available for SonarQube
  displayName: SonarQube Volume Capacity
  name: SONAR_VOLUME_CAPACITY
  value: 1Gi
- description: Volume space available for SonarQube Database
  displayName: SonarQube database Volume Capacity
  name: SONAR_DB_CAPACITY
  value: 2Gi