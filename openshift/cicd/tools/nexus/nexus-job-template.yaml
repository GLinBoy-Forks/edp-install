apiVersion: v1
kind: Template
labels:
  template: nexus3-post-configuration-template
metadata:
  name: nexus3-post-configuration
  #namespace: team-mb
  annotations:
    description: |-
          Nexus configuration to be applied.
          NOTE: You must have Nexus available in your cluster to use this template.
    iconClass: icon-jenkins
    openshift.io/display-name: Nexus Configuration
    tags: ci-cd
    #template.openshift.io/documentation-url: https://docs.openshift.org/latest/using_images/other_images/jenkins.html
    template.openshift.io/long-description: This template deploys a Nexus server
      capable of managing OpenShift Pipeline builds and supporting OpenShift-based
      oauth login.
    template.openshift.io/provider-display-name: Red Hat, Inc.
    template.openshift.io/support-url: https://access.redhat.com
objects:
- apiVersion: batch/v1
  kind: Job
  metadata:
    name: nexus-integration
  spec:
    parallelism: 1
    completions: 1
    template:
      metadata:
        name: nexus-integration
      spec:
        initContainers:
          - name: init-nexus
            image: busybox
            command: ["sh", "-c", "while ! nc -w 1 ${NEXUS_HOST} ${NEXUS_PORT} </dev/null; do echo waiting for ${NEXUS_HOST}; sleep 10; done;"]
        volumes:
        - name: python-script
          configMap:
            defaultMode: 420
            name: nexus-integration
        containers:
        - name: nexus-integration
          image:  python:3.6-alpine
          imagePullPolicy: IfNotPresent
          command: ["python", "/tmp/config.py"]
          env:
          - name: NEXUS_HOST
            value: ${NEXUS_HOST}
          - name: NEXUS_PORT
            value: ${NEXUS_PORT}
          - name: NEXUS_ADMIN
            value: ${NEXUS_ADMIN}
          - name: NEXUS_PASSWORD
            value: ${NEXUS_PASSWORD}
          - name: NPM_BLOB_STORAGE
            value: ${NPM_BLOB_STORAGE}
          - name: NPM_SNAPSHOTS
            value: ${NPM_SNAPSHOTS}
          - name: NPM_REGISTRY
            value: ${NPM_REGISTRY}
          - name: NPM_GROUP
            value: ${NPM_GROUP}
          - name: NPM_READ_ROLE
            value: ${NPM_READ_ROLE}
          - name: NPM_PUBLISH_ROLE
            value: ${NPM_PUBLISH_ROLE}
          - name: NPM_READ_USER
            value: ${NPM_READ_USER}
          - name: NPM_PUBLISH_USER
            value: ${NPM_PUBLISH_USER}
          - name: NPM_READ_PASSWORD
            value: ${NPM_READ_PASSWORD}
          - name: NPM_PUBLISH_PASSWORD
            value: ${NPM_PUBLISH_PASSWORD}
          - name: JENKINS_HOST
            value: ${JENKINS_HOST}
          - name: JENKINS_PORT
            value: ${JENKINS_PORT}
          - name: JENKINS_ADMIN
            value: ${JENKINS_ADMIN}
          - name: JENKINS_PASSWORD
            value: ${JENKINS_PASSWORD}
          - name: APP_FILE
            value: "/tmp/config.py"
          volumeMounts:
          - mountPath: /tmp
            name: python-script
        restartPolicy: Never
    backoffLimit: 1
parameters:
- displayName: Sonatype Nexus service name
  name: NEXUS_HOST
  value: nexus
- displayName: Sonatype Nexus service port
  name: NEXUS_PORT
  value: "8081"
- displayName: Sonatype Nexus service admin user
  name: NEXUS_ADMIN
  value: admin
- displayName: Sonatype Nexus service admin password
  name: NEXUS_PASSWORD
  value: admin123
- description: Blob name inside Nexus to be created
  displayName: NPM blob name
  name: NPM_BLOB_STORAGE
  value: npm-blob-test
- description: Repo name inside Nexus to be created
  displayName: NPM snapshots repo
  name: NPM_SNAPSHOTS
  value: npm-snap-test
- description: Repo name inside Nexus to be created
  displayName: NPM regular repo
  name: NPM_REGISTRY
  value: npm-reg-test
- description: Repo name inside Nexus to be created
  displayName: NPM group repo
  name: NPM_GROUP
  value: npm-group-test
- description: Role name inside Nexus to be created
  displayName: NPM read only role
  name: NPM_READ_ROLE
  value: npm-read-role-test
- description: User name inside Nexus to be created
  displayName: NPM read only user
  name: NPM_READ_USER
  value: npm-read-user-test
- description: User password inside Nexus to be created
  displayName: NPM read only user password
  name: NPM_READ_PASSWORD
  value: npm-read-role-test
- description: Role name inside Nexus to be created
  displayName: NPM publish role name 
  name: NPM_PUBLISH_ROLE
  value: npm-publish-role-test
- description: User name inside Nexus to be created
  displayName: NPM publish user name 
  name: NPM_PUBLISH_USER
  value: npm-publish-user-test
- description: User password inside Nexus to be created
  displayName: NPM publish user password
  name: NPM_PUBLISH_PASSWORD
  value: npm-publish-user-test
- displayName: Jenkins service name
  name: JENKINS_HOST
  value: jenkins
- displayName: Jenkins service port
  name: JENKINS_PORT
  value: "8080"
- displayName: Jenkins service admin user
  name: JENKINS_ADMIN
  value: admin
- displayName: Jenkins service admin password
  name: JENKINS_PASSWORD
  value: admin123
