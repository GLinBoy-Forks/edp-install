--- # This is a structural YAML example to up a master node
- name: "Install Gerrit-to-Jenkins integration"
  command: "{{ ocadm }} -n {{ project }} new-app -f {{ templates_dir }}/gerrit/gerrit-integration.yaml -p GERRIT_HOST={{ integration.gerrit.host }} -p GERRIT_PORT={{ integration.gerrit.port }} -p GERRIT_ADMIN={{ integration.gerrit.admin }} -p GERRIT_PASSWORD={{ integration.gerrit.password }} "
  register: result
  ignore_errors: true
  changed_when: '"already" not in result.stderr'
  failed_when:
    - 'result.rc != 0'
    - '"already" not in result.stderr'

#- name: "Return OAUTH back"
#  shell: "{{ ocadm }} project {{ project }} && {{ ocadm }} set env dc gerrit AUTH_TYPE='OAUTH'"


- name: "Install Nexus-to-Jenkins integration"
  command: "{{ ocadm }} -n {{ project }} new-app -f {{ templates_dir }}/nexus/nexus-integration.yaml -p NEXUS_HOST={{ integration.nexus.host }} -p NEXUS_PORT={{ integration.nexus.port }} -p NEXUS_ADMIN={{ integration.nexus.admin }} -p NEXUS_PASSWORD={{ integration.nexus.password }} -p NPM_BLOB_STORAGE={{ integration.nexus.npm_blob }} -p NPM_SNAPSHOTS={{ integration.nexus.npm_snap }} -p NPM_REGISTRY={{ integration.nexus.npm_reg }} -p NPM_GROUP={{ integration.nexus.npm_group }} -p NPM_READ_ROLE={{ integration.nexus.read_role }} -p NPM_READ_USER={{ integration.nexus.read_user }} -p NPM_READ_PASSWORD={{ integration.nexus.read_password }} -p NPM_PUBLISH_ROLE={{ integration.nexus.publish_role }} -p NPM_PUBLISH_USER={{ integration.nexus.publish_user }} -p NPM_PUBLISH_PASSWORD={{ integration.nexus.publish_password }} -p JENKINS_HOST={{ integration.nexus.jenkins_host }} -p JENKINS_PORT={{ integration.nexus.jenkins_port }} -p JENKINS_ADMIN={{ integration.nexus.jenkins_admin }} -p JENKINS_PASSWORD={{ integration.nexus.jenkins_password }} "
  register: result
  ignore_errors: true
  changed_when: '"already" not in result.stderr'
  failed_when:
    - 'result.rc != 0'
    - '"already" not in result.stderr'

- name: "Install Sonar-to-Jenkins integration"
  command: "{{ ocadm }} -n {{ project }} new-app -f {{ templates_dir }}/sonar/sonar-integration.yaml -p SONAR_HOST={{ integration.sonar.host }} -p SONAR_PORT={{ integration.sonar.port }} -p SONAR_ADMIN={{ integration.sonar.admin }} -p AUTO_USER={{ integration.sonar.auto_user }} -p AUTO_USER_PASSWORD={{ integration.sonar.auto_user_password }} "
  register: result
  ignore_errors: true
  changed_when: '"already" not in result.stderr'
  failed_when:
    - 'result.rc != 0'
    - '"already" not in result.stderr'
