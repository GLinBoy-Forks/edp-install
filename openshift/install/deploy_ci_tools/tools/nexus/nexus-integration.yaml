apiVersion: v1
kind: Template
labels:
  template: nexus3-post-configuration-template
metadata:
  name: nexus3-post-configuration
  #namespace: team-mb
  annotations:
    description: |-
          Nexus configuration to be applied.
          NOTE: You must have Nexus available in your cluster to use this template.
    iconClass: icon-jenkins
    openshift.io/display-name: Nexus Configuration
    tags: ci-cd
    #template.openshift.io/documentation-url: https://docs.openshift.org/latest/using_images/other_images/jenkins.html
    template.openshift.io/long-description: This template deploys a Nexus server
      capable of managing OpenShift Pipeline builds and supporting OpenShift-based
      oauth login.
    template.openshift.io/provider-display-name: Red Hat, Inc.
    template.openshift.io/support-url: https://access.redhat.com
objects:
- apiVersion: batch/v1
  kind: Job
  metadata:
    name: nexus-integration
  spec:
    parallelism: 1
    completions: 1
    template:
      metadata:
        name: nexus-integration
      spec:
        initContainers:
        - name: init-jenkins
          image: busybox
          command: ["sh", "-c", "while ! nc -w 1 jenkins 8080 </dev/null; do echo waiting for jenkins; sleep 10; done;"]
        - name: init-nexus
          image: busybox
          command: ["sh", "-c", "while ! nc -w 1 nexus 8081 </dev/null; do echo waiting for nexus; sleep 10; done;"]
        volumes:
        - name: python-script
          configMap:
            defaultMode: 420
            name: nexus-integration
        containers:
        - name: nexus-integration
          image:  python:3.6-alpine
          imagePullPolicy: IfNotPresent
          command: ["python", "/tmp/config.py"]
          env:
          - name: NEXUS_HOST
            value: nexus
          - name: NEXUS_PORT
            value: "8081"
          - name: NEXUS_ADMIN
            value: admin
          - name: NEXUS_PASSWORD
            value: admin123
          - name: NPM_BLOB_STORAGE
            value: npm-blob
          - name: NPM_SNAPSHOTS
            value: npm-snapshots
          - name: NPM_REGISTRY
            value: npm-proxy
          - name: NPM_GROUP
            value: npm-group
          - name: NPM_READ_ROLE
            value: npm-read
          - name: NPM_PUBLISH_ROLE
            value: npm-publish
          - name: NPM_READ_USER
            value: npm-reader
          - name: NPM_READ_PASSWORD
            value: npm-reader
          - name: NPM_PUBLISH_USER
            value: npm-publish
          - name: NPM_PUBLISH_PASSWORD
            value: npm-publish
          - name: JENKINS_HOST
            value: jenkins
          - name: JENKINS_PORT
            value: "8080"
          - name: JENKINS_ADMIN
            value: admin
          - name: JENKINS_PASSWORD
            value: password
          - name: APP_FILE
            value: "/tmp/config.py"
          volumeMounts:
          - mountPath: /tmp
            name: python-script
        restartPolicy: Never
    backoffLimit: 1
